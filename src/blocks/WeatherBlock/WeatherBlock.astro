---
import type { WeatherBlockFragment } from '@lib/datocms/types';

export interface Props {
    block: WeatherBlockFragment
}

const { block } = Astro.props;

const defaultCity = block.defaultCity;

// Fetch from your server API endpoint
const weatherData = await fetch(
  `${Astro.url.origin}/api/weather/${defaultCity}`
).then(r => r.json());


const icon = weatherData?.currentConditions?.icon
  ? `https://raw.githubusercontent.com/visualcrossing/WeatherIcons/main/PNG/4th%20Set%20-%20Color/${weatherData?.currentConditions.icon}.png`
  : '';
const iconAlt = `A weather icon that represents the weathercondition; ${weatherData?.currentConditions?.conditions}`;
const day = block.defaultCity ? weatherData?.days[0] : null;
  
---

<script src="./WeatherBlock.client.ts"></script>

<section
  id="weather-block"
  data-default-city={block.defaultCity}
  data-forecast={block.forecast}
>
  <h2>{block.title}</h2>
  <p>{block.infoText}</p>

  <div id="weather-search">
    <input id="city-input" placeholder="Type in a city..." />
    <button id="search-button">Search</button>
    <button id="geolocation-button">Use my location</button>
      <!-- TODO add autocomplete list for searching places -->
  </div>

  <div id="weather-output">
    {!block.defaultCity ? (
      <p>No default weather information set.</p>
    ) : ''}

    <div class={!block.defaultCity ? ('hide') : ''}>
      <p class="weekday">{new Date(day?.datetime).toLocaleDateString('en-EN', { weekday: 'long' })}; at {weatherData?.address}</p>
      <div class="weather-now">
        <p class="temperature"><strong>{weatherData?.currentConditions?.temp}</strong></p>
        <p class="range">{day?.tempmax}° / {day?.tempmin}°</p>
        <img class="icon" src={icon} alt={iconAlt} />
      </div>
    </div>

    <div class="weather-forecast">
      <!-- Template for the client script -->
      <template id="forecast-template">
        <div class="weather-forecast-day">
          <p class="day"></p>
          <img class="icon" src="" alt=""/>
          <p class="range"></p>
        </div>
      </template>
    </div>
  </div>
</section>

<style>
  #weather-block {
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 8px;
  }
  #weather-search {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5em;
    flex-wrap: wrap;
  }
  #city-input {
    flex: 1;
    min-width: 10em;
    padding: 0.5em;
    &.input-error {
      border: 1px solid red;
    }
  }
  #search-button, #geolocation-button {
    padding: 0.5em 1em;
    cursor: pointer;
  }
  #weather-output {
    img {
      height: fit-content;
      width: 100%;
    }
    .hide {
      display: none;
    }
    .weather-now {
        display: grid;
        grid-template-columns: minmax(3em, 6em) auto;
        grid-template-rows: auto auto;
        column-gap: 1em;
        img {
          grid-column: 1/2;
          grid-row: 1/3;
          align-self: center;
        }
        p {
          grid-column: 2/3;
          grid-row: 1/2;
          margin: 0;
          &:nth-of-type(2){
            grid-row: 2/3;
          }
        }
        strong {
          font-size: 2rem;
        }
    }
    
    .weather-forecast {
      display: flex;
      background-color: gray;
      column-gap: 0.1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
      .weather-forecast-day {
        background-color: white;
        flex: 1;
        padding: 1em;
        padding-block: 0;
        img {
          aspect-ratio: 1 / 1;
          object-fit: contain;
          object-position: top;
          max-width: 4em;
          min-width: 3em;
        }
      }
    }
  }
</style>